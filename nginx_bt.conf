# 微信问卷系统Nginx配置 - 适合宝塔面板部署

# 服务器配置
server {
    # 监听端口（HTTP）
    listen 80;
    
    # 监听端口（HTTPS，配置SSL后启用）
    # listen 443 ssl http2;
    
    # 域名配置（根据实际域名修改）
    server_name your-domain.com www.your-domain.com;
    
    # 网站根目录（指向Django项目目录）
    root /www/wwwroot/wechat_survey;
    
    # 默认文档
    index index.html index.htm index.php;
    
    # SSL证书配置（配置SSL后启用）
    # ssl_certificate    /www/server/panel/vhost/cert/your-domain.com/fullchain.pem;
    # ssl_certificate_key    /www/server/panel/vhost/cert/your-domain.com/privkey.pem;
    # ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    # ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    # ssl_prefer_server_ciphers on;
    # ssl_session_cache shared:SSL:10m;
    # ssl_session_timeout 10m;
    # add_header Strict-Transport-Security "max-age=31536000" always;
    
    # 禁止访问的文件或目录
    location ~ ^/\. {
        deny all;
    }
    
    # 静态文件处理
    location /static/ {
        # 静态文件目录（指向Django收集的静态文件）
        alias /www/wwwroot/wechat_survey/staticfiles/;
        
        # 静态文件缓存配置
        expires 30d;
        add_header Cache-Control public;
        add_header Access-Control-Allow-Origin *;
        
        # 禁止执行静态目录下的PHP文件
        location ~ \.php$ {
            deny all;
        }
    }
    
    # 媒体文件处理
    location /media/ {
        # 媒体文件目录
        alias /www/wwwroot/wechat_survey/media/;
        
        # 媒体文件缓存配置
        expires 7d;
        add_header Cache-Control public;
        add_header Access-Control-Allow-Origin *;
        
        # 禁止执行媒体目录下的PHP文件
        location ~ \.php$ {
            deny all;
        }
    }
    
    # Django应用代理配置
    location / {
        # uwsgi代理配置
        include uwsgi_params;
        uwsgi_pass 127.0.0.1:8001;
        
        # uwsgi参数设置
        uwsgi_param Host $host;
        uwsgi_param X-Real-IP $remote_addr;
        uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
        uwsgi_param X-Forwarded-Proto $scheme;
        uwsgi_param X-Forwarded-Host $http_host;
        uwsgi_param X-Forwarded-Port $server_port;
        
        # 超时设置
        uwsgi_connect_timeout 30s;
        uwsgi_send_timeout 30s;
        uwsgi_read_timeout 30s;
        
        # 缓冲区设置
        uwsgi_buffer_size 32k;
        uwsgi_buffers 4 32k;
        uwsgi_busy_buffers_size 64k;
        uwsgi_temp_file_write_size 64k;
        
        # 错误页面配置
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /www/wwwroot/wechat_survey/templates/errors/;
        }
    }
    
    # 日志配置
    access_log /www/wwwlogs/wechat_survey_access.log;
    error_log /www/wwwlogs/wechat_survey_error.log;
    
    # 压缩配置
    gzip on;
    gzip_min_length 1k;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";
    
    # 其他配置
    client_max_body_size 100m;  # 允许上传的最大文件大小
    keepalive_timeout 65;       # 长连接超时时间
}
